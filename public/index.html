<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SameSite</title>
  </head>
  <body>
    <h1>Test http-only cookies</h1>
    <h2 id="cors"></h2>

    If this pages is running on the same domain/port as the server (i.e.
    <a href="http://localhost:3023">http://localhost:3023</a>), a
    <code>get</code> to an endpoint that does <code>set-cookie</code> should
    store this in the browser, and every subsequent call to an endpoint should
    send the value from this cookie in the request.

    <h2>Step 1 - "login"</h2>

    <p>
      The first call functions as a log in and does a <code>get</code> to an
      eindpoint that does <code>set-cookie</code>. The response contains an
      http-only cookie with the token.

      <input id="password" value="test" />
      <button id="login">login</button>
      <input id="firstname" disabled />
    </p>

    <h2>Step 2 - authenticated endpoints</h2>

    <p>For each subsequent call the cookie is added by the browser.</p>

    <button id="getNickName">get user nickname</button>
    <input id="nickname" disabled />

    <h2>Step 3 - "logout"</h2>

    <p>
      After logout the getNickName endpoint does not work anymore, because the
      Authentication cookies has been overwritten.
    </p>

    <button id="logout">logout</button>

    <h2>Step 4 - CORS</h2>

    <p>
      Open <a href="http://localhost:3024">http://localhost:3024</a> in a new
      browser window. This runs the same client on a different port to be able
      to test CORS. Run steps 1 and 2 in that window, and use the butto nbewlow
      to see that CORS does not work with Fetch, but it does work with XHR/Ajax.
    </p>

    // TODO font // TODO rename corscontros, getnicknamecors to XHR
    <div id="corscontrols" style="display: block">
      <button id="getNickNameCORS">get user nickname with XHR</button>
      <input type="text" id="nicknameXHR" disabled />
    </div>

    <script>
      const isCors = top.location.port === "3024";

      if (isCors) {
        document.body.style.backgroundColor = "#88c2bc";
        document.getElementById("cors").innerText = "CORS * ".repeat("18");
        document.getElementById("corscontrols").style.display = "block";
      }

      const postData = async (url) => {
        const options = isCors ? { credentials: "include" } : {};
        const response = await fetch(`https://localhost:3023/api/${url}`, {
          ...options,
          method: "POST",
          mode: "cors" /* TODO why? */,
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            username: "myuser",
            password: document.getElementById("password"),
          }),
        }).then((data) => data.json());

        document.getElementById("firstname").value = response.firstname;
      };

      document.getElementById("login").addEventListener("click", () => {
        postData("login");
      });
      document.getElementById("logout").addEventListener("click", () => {
        postData("logout");
      }); // TODO this can be a GET

      document
        .getElementById("getNickName")
        .addEventListener("click", async () => {
          const response = await fetch(
            "https://localhost:3023/api/nickname",
            { credentials: "include" } // TODO re-use condition from above
          ).then((data) => data.json());
          document.getElementById("nickname").value = response.nickname;
        });

      const getNickNameWithXHR = (url) =>
        new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.responseType = "json";
          xhr.withCredentials = true; // this works even without SSL, Secure flag, SameSite None flag!
          xhr.open("GET", url, true);
          xhr.onload = () => {
            if (xhr.status === 200) {
              resolve(xhr.response);
            } else {
              reject(`status is ${xhr.status}`); // TODO also resolve(xhr.response); ?
            }
          };
          xhr.send();
        });

      document
        .getElementById("getNickNameCORS")
        .addEventListener("click", async () => {
          try {
            const response = await getNickNameWithXHR(
              "https://localhost:3023/api/nickname"
            );
            document.getElementById("nicknameXHR").value = response.nickname;
          } catch (err) {
            console.error("getNickNameWithXHR failed:", err);
            document.getElementById("nicknameXHR").value = "error";
          }
        });
    </script>
  </body>
</html>
